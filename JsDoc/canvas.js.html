<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: canvas.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: canvas.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Tablica przechowująca podłączonych do sesji użytkowników.
 * @type {Array}
 */
var listId = new Array();
/**
 * Tablica przechowująca połączenia.
 * @type {Array}
 */
var peerCon= new Array();
/**
 * Tablica przechowująca wszystkie ślady rysowania.
 * @type {Array}
 */
var arrayTrace = new Array();
/**
 * Zmienna przechowująca obiekt Peer.
 */
var peer = null;
/**
 * Zmienna przechowująca tymczasowe połączenie.
 * @type {null}
 */
var peerTemp = null;
/**
 * Zmienna informująca czy rysowanie jest aktywne.
 * @type {Boollean}
 */
var paint;
/**
 * Zmienna przechowująca context, umożliwia rysowanie.
 */
var context;
/**
 * Zmienna przechowująca szerokość obszaru rysowania.
 * @type {Number}
 */
var canvasWidth = 500;
/**
 * Zmienna przechowująca wysokość obszaru rysowania.
 * @type {Number}
 */
var canvasHeight = 200;
/**
 * Tablica przechowująca dostępne kolory.
 * @type {Array}
 */
var colors = ["#000000", "#ff0000", "#009933", "#0099ff", "#fffe11"];
/**
 * Zmienna przechowująca aktualnie wybrany kolor.
 * @type {string}
 */
var currentColor = "#000000";
/**
 * Konstruktor klasy Trace, której obiekt przechowuje informacje o śladzie rysowania jednego użytkownika.
 * @param {Number} id Identyfikator użytkownika
 * @constructor
 */
function Trace(id){
    this.id=id;
    this.clickX = new Array();
    this.clickY = new Array();
    this.clickDrag = new Array();
    this.clickColor = new Array();
}
/**
 * Przygotowuje canvas oraz obsługuje zdarzenia.
 */
function prepareSimpleCanvas()
{
    var trace = new Trace(0);
    arrayTrace.push(trace);
    context = document.getElementById('canvas').getContext("2d");
    $('#canvas').mousedown(function(e)
    {
        var mouseX = e.pageX - this.offsetLeft;
        var mouseY = e.pageY - this.offsetTop;
        paint = true;
        sendPoint(mouseX,mouseY,false);
        addClick(mouseX, mouseY, false);
        redraw();
    });
    $('#canvas').mousemove(function(e){
        if(paint){
            var mouseX = e.pageX - this.offsetLeft;
            var mouseY = e.pageY - this.offsetTop;
            sendPoint(mouseX,mouseY,true);
            addClick(mouseX, mouseY, true);
            redraw();
        }
    });
    $('#canvas').mouseup(function(e){
        paint = false;
        redraw();
    });
    $('#canvas').mouseleave(function(e){
        paint = false;
    });
    $('#clearCanvas').mousedown(function(e)
    {
        resetCanvas();
        for(var i=0; i&lt;listId.length;i++){
            sendJson(peerCon[i],JSON.stringify({"msg":6}),listId[i]);
        }
    });
}
/**
 * Dodaje punkt do śladu gospodarza.
 *@param {Number} x Współrzędna x.
 *@param {Number} y Współrzędna y.
 *@param {Boolean} dragging False oznacza początek nowej linii, true, że jest to kontynuacja.
 */
function addClick(x, y, dragging)
{
    arrayTrace[0].clickX.push(x);
    arrayTrace[0].clickY.push(y);
    arrayTrace[0].clickColor.push(currentColor);
    arrayTrace[0].clickDrag.push(dragging);
}
/**
 * Dodaje punkt do śladu gościa.
 *@param {Number} x Współrzędna x.
 *@param {Number} y Współrzędna y.
 *@param {Boolean} dragging False oznacza początek nowej linii, true kontynuację.
 *@param {String} color Kolor linii, przychodzący z zewnątrz.
 *@param {Number} id Identyfikator użytkownika, od którego pochodzą te dane.
 */
function addClick2(x, y, dragging, color,id)
{
    var i=0;
    do{i++;}
    while(id!= arrayTrace[i].id)
    arrayTrace[i].clickX.push(x);
    arrayTrace[i].clickY.push(y);
    arrayTrace[i].clickColor.push(color);
    arrayTrace[i].clickDrag.push(dragging);
}
/**
 * Czyści context.
 */
function clearCanvas()
{
    context.clearRect(0, 0, canvasWidth, canvasHeight);
}
/**
 * Czyści zapisane ślady rysowania.
 */
function resetCanvas()
{
    for(var i=0; i&lt;arrayTrace.length;i++){
        arrayTrace[i].clickX=new Array();
        arrayTrace[i].clickY=new Array();
        arrayTrace[i].clickColor=new Array();
        arrayTrace[i].clickDrag=new Array();
    }
    clearCanvas();
}
/**
 * Czyści sesję.
 */
function clearSession(){
    for(var i=1; i&lt;arrayTrace.length;i++){
        peerTemp=null;
        sendJson(peerTemp,JSON.stringify( {"msg":9, "id": peer.id}),arrayTrace[i].id);
    }
    var tmp=arrayTrace.length;
    for(var i=1; i&lt;tmp;i++){
        arrayTrace.pop();
    }
    arrayTrace[0].clickX=new Array();
    arrayTrace[0].clickY=new Array();
    arrayTrace[0].clickColor=new Array();
    arrayTrace[0].clickDrag=new Array();
    clearCanvas();
    listId = new Array();
    peerCon = new Array();
    document.getElementById("listId").innerHTML="";
}
/**
 * Rysuje wszystkie ślady.
 */
function redraw()
{
    clearCanvas();
    var radius = 5;
    context.strokeStyle = "#df4b26";
    context.lineJoin = "round";
    context.lineWidth = radius;
    for(var j=0; j &lt; arrayTrace.length; j++){
        for(var i=0; i &lt;  arrayTrace[j].clickX.length; i++)
        {
            context.beginPath();
            if( arrayTrace[j].clickDrag[i] &amp;&amp; i){
                context.moveTo( arrayTrace[j].clickX[i-1],  arrayTrace[j].clickY[i-1]);
            }else{
                context.moveTo( arrayTrace[j].clickX[i]-1,  arrayTrace[j].clickY[i]);
            }
            context.lineTo( arrayTrace[j].clickX[i],  arrayTrace[j].clickY[i]);
            context.closePath();
            context.strokeStyle =  arrayTrace[j].clickColor[i];
            context.stroke();
        }
    }
}
/**
 * Inicjalizuje Peer i obsługuje przychodzące komunikaty.
 * 0 - Prośba o dołączenie do sesji.
 * 1 - Komunikat z identyfikatorem użytkownika do dodania.
 * 2 - Przychodzący punkt do narysowania.
 * 3 - Przychodzący cały ślad.
 * 4 - Komunikat z pytaniem czy użytkownik chce dołączyć do sesji.
 * 5 - Użytkownik zaakceptował zaproszenie do sesji, należy mu wysłać stan sesji.
 * 6 - Komunikat informujący o czyszczeniu pola rysowania.
 * 7 - Odrzucono prośbę o dołączenie do sesji.
 * 8 - Zaakceptowano prośbę o dołączenie do sesji.
 * 9 - Informacja o tym, że należy usunąć użytkownika z sesji.
 * 10 - Użytkownik odrzucił zaproszenie do sesji.
 */
function preparePeerJS(){
    if (peer == null) peer = new Peer({ key: 'lwjd5qra8257b9', debug: 3});
    peer.on('open', function(id){
        document.getElementById('pid').innerHTML= "Your id: "+ id;
        arrayTrace[0].id=peer.id;
    });
    $(document).ready(function() {
        peer.on('connection', function(connection) {
            connection.on('data', function(data) {
                var json = JSON.parse(data);
                switch (json.msg){
                    case 2: addClick2(json.x, json.y, json.dragging, json.color,connection.peer);
                        redraw();
                        break;
                    case 0: confirmationId(json.id);
                        break;
                    case 1: addUser(json.id);
                        break;
                    case 3: addTrace(json.trace);
                        redraw();
                        break;
                    case 4: confirmationSession(json.id);
                        break;
                    case 5: sendSessionInfo(json.id);
                        break;
                    case 6: resetCanvas();
                        break;
                    case 7: window.alert("The user "+json.id+" has rejected your request.");
                        break;
                    case 8: window.alert("The user "+json.id+" has accepted your request.");
                        clearSession();
                        break;
                    case 9: deleteUser(json.id);
                        break;
                    case 10: window.alert("The user "+json.id+" has rejected your invitation.");
                }
            });
        });
    });
}
/**
 * Dołączenie lub odrzucenie prośby innego użytkownika o dołączenie do sesji.
 * @param {Number} id Identyfikator użytkownika
 */
function confirmationId(id){
    var conf = confirm("Do you want to add user: " + id + " to the session?");
    if(conf == true){
        addUser(id);
        peerTemp=null;
        sendJson(peerTemp, JSON.stringify( {"msg":8, "id": peer.id}), id);
        sendJson(peerTemp, JSON.stringify( {"msg":1, "id": peer.id}), id);
        for( var i=0; i&lt;listId.length; i++){
            if(id!=listId[i]){
                sendJson(peerTemp,JSON.stringify( {"msg":1, "id": id}), listId[i]);
                sendJson(peerTemp,JSON.stringify( {"msg":1, "id": listId[i]}),id);
            }
        }
        sendAllPoints(id);
    }
    else{
        sendJson(peerTemp, JSON.stringify( {"msg":7, "id": peer.id}), id);
    }
}
/**
 * Dołączenie lub odrzucenie zaproszenia do sesji.
 * @param {Number} id Identyfikator użytkownika.
 */
function confirmationSession(id){
    var conf = confirm("Do you want to join to session of user: " + id + " ?");
    if(conf==true){
        clearSession();
        addUser(id);
        peerTemp=null;
        sendJson(peerTemp,  JSON.stringify( {"msg":5, "id": peer.id}), id);
    }
    else sendJson(peerTemp,  JSON.stringify( {"msg":10, "id": peer.id}), id);
}
/**
 * Usunięcie użytkownika i jego śladów z sesji.
 * @param {Number} id Identyfikator użytkownika.
 */
function deleteUser(id){
    var i = listId.indexOf(id);
    if (i > -1) {
        listId.splice(i, 1);
        peerCon.splice(i, 1);
    }
    document.getElementById("listId").innerHTML="";
    for(var i=0; i&lt;listId.length;i++){
        var node = document.createElement("li");
        var textnode = document.createTextNode(listId[i]);
        node.appendChild(textnode)
        document.getElementById("listId").appendChild(node);
    }
    i=0;
    do{i++;}
    while(id!= arrayTrace[i].id);
    if (i > -1) {
        arrayTrace.splice(i, 1);
    }
    redraw();
}
/**
 * Dodanie całego śladu użytkownika do tablicy.
 * @param {Object} trace Ślad użytkownika.
 */
function addTrace(trace){
    var i=0;
    do{i++;}
    while(trace.id!= arrayTrace[i].id)
    arrayTrace[i]=trace;
}
/**
 * Uniwersalna funkcja do wysyłania komunikatów.
 * @param {Object} peerCon Połączenie.
 * @param {String} json Treść komunikatu w formacie JSON.
 * @param {Number} id Identyfikator odbiorcy.
 */
function sendJson(peerCon, json, id){
    if(peerCon != null){
        peerCon.send(json);
    }
    else{
        peerCon = peer.connect(id);
        peerCon.on('open', function () {
            peerCon.send(json);
        });
    }
}
/**
 * Wysłanie informacji o sesji do nowego użytkownika, identyfikatorów podłączonych i śladów.
 * @param {Number} id Identyfikator użytkownika.
 */
function sendSessionInfo(id){
    addUser(id);
    peerTemp=null;
    for( var i=0; i&lt;listId.length; i++){
        if(id!=listId[i]){
            sendJson(peerTemp,JSON.stringify( {"msg":1, "id": id}), listId[i]);
            sendJson(peerTemp,JSON.stringify( {"msg":1, "id": listId[i]}),id);
        }
    }
    sendAllPoints(id);
    window.alert("The user "+id+" joined to the session.");
}
/**
 * Wysłanie punktu do wszystkich użytkowników sesji.
 * @param {Number} X Współrzędna x.
 * @param {Number} Y Współrzędna y.
 * @param {Boolean} dragging alse oznacza początek nowej linii, true kontynuację.
 */
function sendPoint(X,Y,dragging) {
    for (i = 0; i &lt; listId.length; i++) {
        if (peerCon[i] != null) {
            peerCon[i].send(JSON.stringify({"msg": 2, "x": X, "y": Y, "dragging": dragging, "color": currentColor}));
        }
        else {
            peerCon[i] = peer.connect(listId[i]);
            peerCon[i].on('open', function () {
                peerCon[i].send(JSON.stringify({"msg": 2, "x": X, "y": Y, "dragging": dragging, "color": currentColor}));
            });
        }
    }
}
/**
 * Wysłanie wszystkich śladów sesji do danego użytkownika.
 * @param {Number} id Identyfikator użytkownika.
 */
function sendAllPoints(id){
    peerTemp = null;
    for(var i=0;i&lt;arrayTrace.length;i++){
        if(id!=arrayTrace[i].id){
            var points = {"msg": 3, "trace": arrayTrace[i]};
            sendJson(peerTemp, JSON.stringify(points),id);
        }
    }
}
/**
 * Zmiana koloru rysowania.
 */
function changeColor(){
    currentColor = colors[document.getElementById("selectColor").value];
    document.getElementById("selectColor").setAttribute("style","background:"+currentColor);

}
/**
 * Dodanie użytkownika do listy odbiorców.
 * @param {Number} id Identyfikator użytkownika.
 */
function addUser(id){
    listId.push(id);
    var trace = new Trace(id);
    arrayTrace.push(trace);
    peerTemp = peer.connect(listId[listId.length-1]);
    peerCon.push(peerTemp);
    var node = document.createElement("li");
    var textnode = document.createTextNode(listId[listId.length-1]);
    node.appendChild(textnode)
    document.getElementById("listId").appendChild(node);
}
/**
 * Funkcja wywoływana po naciśnięciu "End and Join", służy do wysłania prośby o dołączenie do sesji.
 */
function joinToOther(){
    var joinId = document.getElementById("otherId").value
    if(joinId!=''){
        if(idIsOnList(joinId)==false){
            peerTemp = null;
            sendJson( peerTemp, JSON.stringify({"msg" : 0, "id": peer.id}), document.getElementById("otherId").value);
        }
        else window.alert("You have already joined this session");
    }
    else window.alert("The ID field cannot be empty.");
    document.getElementById("otherId").value='';

}
/**
 * Sprawdzenie czy użytkownik o danym id jest już na liście odbiorców.
 * @param {Number} id Identyfikator użytkownika.
 * @returns {boolean} True - jest na liście, False - nie ma na liście.
 */
function idIsOnList(id){
    if(id==peer.id) return true;
    for(var i=0; i&lt;listId.length;i++){
        if (id == listId[i]) return true;
    }
    return false;
}
/**
 * Funkcja wywoływana po naciśnięciu "Add", służy do wysłania zaproszenie do użytkownika.
 */
function addOtherUser(){
    var userId = document.getElementById("userId").value;
    if(userId!=''){
        if(idIsOnList(userId)==false){
            peerTemp=null;
            sendJson(peerTemp, JSON.stringify({"msg" : 4, "id": peer.id}), userId);
        }
        else window.alert("This ID is already on the list.");
    }
    else window.alert("The ID field cannot be empty.");
    document.getElementById("userId").value='';
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Trace.html">Trace</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addClick">addClick</a></li><li><a href="global.html#addClick2">addClick2</a></li><li><a href="global.html#addOtherUser">addOtherUser</a></li><li><a href="global.html#addTrace">addTrace</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#arrayTrace">arrayTrace</a></li><li><a href="global.html#canvasHeight">canvasHeight</a></li><li><a href="global.html#canvasWidth">canvasWidth</a></li><li><a href="global.html#changeColor">changeColor</a></li><li><a href="global.html#clearCanvas">clearCanvas</a></li><li><a href="global.html#clearSession">clearSession</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#confirmationId">confirmationId</a></li><li><a href="global.html#confirmationSession">confirmationSession</a></li><li><a href="global.html#context">context</a></li><li><a href="global.html#currentColor">currentColor</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#idIsOnList">idIsOnList</a></li><li><a href="global.html#joinToOther">joinToOther</a></li><li><a href="global.html#listId">listId</a></li><li><a href="global.html#paint">paint</a></li><li><a href="global.html#peer">peer</a></li><li><a href="global.html#peerCon">peerCon</a></li><li><a href="global.html#peerTemp">peerTemp</a></li><li><a href="global.html#preparePeerJS">preparePeerJS</a></li><li><a href="global.html#prepareSimpleCanvas">prepareSimpleCanvas</a></li><li><a href="global.html#redraw">redraw</a></li><li><a href="global.html#resetCanvas">resetCanvas</a></li><li><a href="global.html#sendAllPoints">sendAllPoints</a></li><li><a href="global.html#sendJson">sendJson</a></li><li><a href="global.html#sendPoint">sendPoint</a></li><li><a href="global.html#sendSessionInfo">sendSessionInfo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Jun 13 2017 09:44:24 GMT+0200 (Środkowoeuropejski czas letni)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
